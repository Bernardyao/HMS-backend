# 收费模块 (Cashier/Charging Module) 开发文档

## 1. 模块概述
收费模块是 HIS 系统的核心业务闭环之一，负责处理挂号费、处方药费的计算、支付确认、退费处理以及每日财务结算。

## 2. 数据库设计
### 2.1 数据表
- **his_charge (收费主表)**: 记录收费单状态、支付金额、流水号、支付时间等。
- **his_charge_detail (收费明细表)**: 记录挂号费、处方费等具体项目明细。

### 2.2 状态机
- **收费状态 (ChargeStatusEnum)**: `0=未缴费 (UNPAID)`, `1=已缴费 (PAID)`, `2=已退费 (REFUNDED)`
- **处方状态 (PrescriptionStatusEnum)**: 
  - `2=已审核` -> 支付成功 -> `5=已缴费 (PAID)`
  - `5=已缴费` -> 发药 -> `3=已发药`
  - `5=已缴费` -> 退费 -> `2=已审核` (不扣库存)
  - `3=已发药` -> 退费 -> `4=已退费` (自动恢复库存)

## 3. 核心业务逻辑
### 3.1 收费单创建
- 自动汇总挂号费和已审核处方的金额。
- 生成全局唯一收费单号 `CHG + yyyyMMddHHmmss + 随机3位`。

### 3.2 支付处理 (Mock)
- 支持多种支付方式：现金、银行卡、微信、支付宝、医保。
- 采用 **幂等性设计**：通过 `transaction_no` (交易流水号) 确保重复请求不会导致多次扣费。
- 支付成功后，自动同步更新关联处方的状态为 `5 (已缴费)`。

### 3.3 退费逻辑 (自动库存恢复)
- 如果处方已发药，退费时会自动调用 `PrescriptionService.restoreInventoryOnly()` 恢复药品库存。
- 确保财务状态与实物库存的一致性。

### 3.4 每日结算
- 提供按日期统计的功能，支持按支付方式汇总金额和笔数。
- 计算净收入（总额 - 退费）。

## 4. API 接口规范
| 方法 | 路径 | 说明 | 角色权限 |
| --- | --- | --- | --- |
| POST | `/api/cashier/charges` | 创建收费单 | CASHIER, ADMIN |
| GET | `/api/cashier/charges/{id}` | 查询详情 | CASHIER, ADMIN |
| GET | `/api/cashier/charges` | 列表查询 (分页/筛选) | CASHIER, ADMIN |
| POST | `/api/cashier/charges/{id}/pay` | 确认支付 | CASHIER, ADMIN |
| POST | `/api/cashier/charges/{id}/refund` | 处理退费 | CASHIER, ADMIN |
| GET | `/api/cashier/charges/statistics/daily` | 每日结算报表 | CASHIER, ADMIN |

## 5. 测试策略
采用 **分层测试模式** 确保系统稳定性：
- **单元测试**: 使用 H2 内存数据库 (`unit-test` profile)，覆盖 Service 层业务逻辑。
- **集成测试**: 使用真实 PostgreSQL 数据库 (`integration-test` profile)，覆盖 Controller 及完整工作流。
- **自动化测试**: 涵盖正常支付、幂等性、库存自动恢复、非法状态拦截等场景。

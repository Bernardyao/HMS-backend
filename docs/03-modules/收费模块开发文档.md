# 收费模块 (Cashier/Charging Module) 开发文档

## 1. 模块概述
收费模块是 HIS 系统的核心业务闭环之一，负责处理挂号费、处方药费的计算、支付确认、退费处理以及每日财务结算。

## 2. 数据库设计
### 2.1 数据表
- **his_charge (收费主表)**: 记录收费单状态、支付金额、流水号、支付时间等。
  - 主要字段：
    - `main_id`: 主键ID
    - `charge_no`: 收费单号（格式：CHG + yyyyMMddHHmmss + 3位随机数）
    - `patient_main_id`: 患者ID（外键）
    - `registration_main_id`: 挂号记录ID（外键）
    - `total_amount`: 应收金额
    - `actual_amount`: 实收金额
    - `discount_amount`: 优惠金额
    - `insurance_amount`: 医保金额
    - `refund_amount`: 退费金额
    - `status`: 收费状态（0=未缴费, 1=已缴费, 2=已退费）
    - `payment_method`: 支付方式（1=现金, 2=银行卡, 3=微信, 4=支付宝, 5=医保）
    - `transaction_no`: 交易流水号（用于幂等性控制）
    - `charge_time`: 收费时间
    - `refund_time`: 退费时间
    - `refund_reason`: 退费原因

- **his_charge_detail (收费明细表)**: 记录挂号费、处方费等具体项目明细。
  - 主要字段：
    - `main_id`: 主键ID
    - `charge_main_id`: 收费主记录ID（外键）
    - `item_type`: 项目类型（REGISTRATION=挂号费, PRESCRIPTION=处方药费）
    - `item_id`: 项目关联ID（挂号ID或处方ID）
    - `item_name`: 项目名称
    - `item_amount`: 项目金额

### 2.2 状态机
- **收费状态 (ChargeStatusEnum)**: `0=未缴费 (UNPAID)`, `1=已缴费 (PAID)`, `2=已退费 (REFUNDED)`
- **处方状态 (PrescriptionStatusEnum)**:
  - `0=草稿 (DRAFT)`
  - `1=已开方 (ISSUED)`
  - `2=已审核 (REVIEWED)`
  - `3=已发药 (DISPENSED)`
  - `4=已退费 (REFUNDED)`
  - `5=已缴费 (PAID)`

**状态转换图**:
```
处方状态转换：
REVIEWED(2) ──支付成功──> PAID(5)
PAID(5) ──发药──> DISPENSED(3)
PAID(5) ──退费（未发药）──> REVIEWED(2)
DISPENSED(3) ──退费（已发药）──> REFUNDED(4)

收费状态转换：
UNPAID(0) ──支付成功──> PAID(1)
PAID(1) ──退费──> REFUNDED(2)
```

## 3. 核心业务逻辑
### 3.1 收费单创建
- 自动汇总挂号费和已审核处方的金额。
- 生成全局唯一收费单号 `CHG + yyyyMMddHHmmss + 随机3位`。

### 3.2 支付处理
- **支付方式枚举**：
  - `1 = CASH (现金)`
  - `2 = CARD (银行卡)`
  - `3 = WECHAT (微信)`
  - `4 = ALIPAY (支付宝)`
  - `5 = INSURANCE (医保)`
- 采用 **幂等性设计**：通过 `transaction_no` (交易流水号) 确保重复请求不会导致多次扣费。
- 支付成功后，自动同步更新关联处方的状态为 `5 (已缴费)`。

### 3.3 退费逻辑 (自动库存恢复)
- 如果处方已发药，退费时会自动调用 `PrescriptionService.restoreInventoryOnly()` 恢复药品库存。
- 确保财务状态与实物库存的一致性。

### 3.4 每日结算
- 提供按日期统计的功能，支持按支付方式汇总金额和笔数。
- 计算净收入（总额 - 退费）。

## 4. API 接口规范
所有接口均需要 `CASHIER` 或 `ADMIN` 角色权限。

### 4.1 接口列表
| 方法 | 路径 | 说明 | 角色权限 |
| --- | --- | --- | --- |
| POST | `/api/cashier/charges` | 创建收费单 | CASHIER, ADMIN |
| GET | `/api/cashier/charges/{id}` | 查询详情 | CASHIER, ADMIN |
| GET | `/api/cashier/charges` | 列表查询 (分页/筛选) | CASHIER, ADMIN |
| POST | `/api/cashier/charges/{id}/pay` | 确认支付 | CASHIER, ADMIN |
| POST | `/api/cashier/charges/{id}/refund` | 处理退费 | CASHIER, ADMIN |
| GET | `/api/cashier/charges/statistics/daily` | 每日结算报表 | CASHIER, ADMIN |

### 4.2 主要DTO说明

#### CreateChargeDTO (创建收费单)
```java
{
  "registrationId": Long,      // 必填：挂号记录ID
  "prescriptionIds": List<Long> // 选填：处方ID列表
}
```

#### PaymentDTO (支付请求)
```java
{
  "paymentMethod": Short,      // 必填：支付方式（1=现金,2=银行卡,3=微信,4=支付宝,5=医保）
  "transactionNo": String,      // 必填：交易流水号（用于幂等性控制）
  "paidAmount": BigDecimal     // 必填：实付金额
}
```

#### RefundRequest (退费请求)
```java
{
  "refundReason": String       // 必填：退费原因
}
```

## 5. 测试策略
采用 **分层测试模式** 确保系统稳定性：

### 5.1 单元测试
- **数据库**: H2 内存数据库 (`test` profile)
- **配置文件**: `application-test.properties`
- **覆盖范围**: Service 层业务逻辑
- **测试框架**: JUnit 5 + Mockito

### 5.2 集成测试
- **数据库**: 真实 PostgreSQL 数据库 (`integration-test` profile)
- **配置文件**: `application-integration-test.yml`
- **覆盖范围**: Controller 层及完整业务流程
- **测试文件**: `CashierWorkflowIntegrationTest.java`
- **测试用例数量**: 5 个
  1. ✅ 完整流程：收费 → 支付 → 发药 → 退费
  2. ✅ 异常场景：支付金额不匹配
  3. ✅ 异常场景：重复支付（幂等性测试）
  4. ✅ 边界条件：只包含挂号费
  5. ✅ 异常场景：退费未支付的收费单

### 5.3 测试覆盖
- ✅ 正常业务流程
- ✅ 支付金额验证
- ✅ 幂等性保证
- ✅ 边界条件测试
- ✅ 异常状态处理
- ✅ 库存管理（扣减/恢复）
- ✅ 状态转换验证

## 6. 版本历史

| 版本 | 日期 | 更新内容 | 作者 |
|------|------|----------|------|
| 1.0.0 | 2025-12-27 | 初始版本，完成收费模块核心功能 | Claude |
| 1.1.0 | 2025-12-27 | 更新文档：补充数据库字段说明、状态转换图、DTO说明、测试策略详情 | Claude |

## 7. 附录

### 7.1 相关文件
- **Controller**: `ChargeController.java`
- **Service**: `ChargeService.java`, `ChargeServiceImpl.java`
- **Entity**: `Charge.java`, `ChargeDetail.java`
- **Repository**: `ChargeRepository.java`, `ChargeDetailRepository.java`
- **DTO**: `CreateChargeDTO.java`, `PaymentDTO.java`
- **VO**: `ChargeVO.java`, `DailySettlementVO.java`
- **Enum**: `ChargeStatusEnum.java`, `PaymentMethodEnum.java`
- **测试**: `ChargeServiceImplTest.java`, `ChargeControllerTest.java`, `CashierWorkflowIntegrationTest.java`

### 7.2 相关SQL
- 数据库迁移脚本: `sql/update_20251227_cashier.sql`

### 7.3 参考资料
- Spring Data JPA 文档
- PostgreSQL 14.8 文档
- JUnit 5 测试最佳实践

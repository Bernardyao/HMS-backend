# ============================================================
# Production Environment Configuration
# ============================================================
# WARNING: 请确保所有敏感信息已妥善保护！
# ============================================================

server:
  port: 8080
  # 启用反向代理支持
  forward-headers-strategy: native
  servlet:
    context-path: /
    session:
      timeout: 30m
      cookie:
        http-only: true
        secure: true
  # 启用压缩
  compression:
    enabled: true
    mime-types: text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json
    min-response-size: 1024
  # 生产环境不暴露错误信息
  error:
    include-message: never
    include-binding-errors: never
    include-stacktrace: never
    include-exception: false
    whitelabel:
      enabled: false

spring:
  # 数据源配置 - 生产环境
  # 使用Docker容器内的PostgreSQL服务
  datasource:
    url: jdbc:postgresql://postgres:5432/his_project
    username: ${POSTGRES_USER:his_user}
    password: ${POSTGRES_PASSWORD}
    driver-class-name: org.postgresql.Driver
    # HikariCP 连接池配置 - 生产环境优化
    hikari:
      minimum-idle: 2                    # 减少初始连接，加快启动
      maximum-pool-size: 15
      idle-timeout: 600000
      max-lifetime: 1800000
      connection-timeout: 10000          # 10秒超时（原20秒）
      initialization-fail-timeout: 30000 # 初始化超时30秒
      connection-test-query: SELECT 1
      leak-detection-threshold: 60000
      pool-name: HisHikariPool           # 便于日志识别

  # JPA/Hibernate 配置 - 生产环境
  jpa:
    database-platform: org.hibernate.dialect.PostgreSQLDialect
    hibernate:
      # 重要：生产环境绝不使用 create 或 create-drop！
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        format_sql: false
        use_sql_comments: false
        generate_statistics: false
        cache:
          use_second_level_cache: false
          use_query_cache: false

# ============================================================
# Swagger/Knife4j 配置 - 生产环境
# ============================================================
app:
  swagger:
    # 【重要】禁用 Swagger（生产环境必须关闭）
    enabled: false
    # 即使误开启，也需要认证
    require-auth: true
    # 只允许管理员访问
    allowed-roles:
      - ADMIN
    # 启用生产环境警告
    warn-on-production: true

# 日志配置 - 生产环境（优化：显示启动日志）
logging:
  level:
    root: INFO                           # WARN → INFO，显示启动信息
    com.his: INFO
    org.springframework.boot: INFO        # 显示Spring Boot启动信息
    org.flywaydb: INFO                   # 显示Flyway迁移进度
    com.zaxxer.hikari: INFO              # 显示连接池状态
    org.hibernate.SQL: WARN
    org.springframework.web: WARN
    org.springframework.security: WARN   # 减少安全日志噪音
  pattern:
    console: '%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n'
    file: '%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n'
  file:
    name: logs/his-application.log
    max-size: 100MB
    max-history: 30

# Actuator 配置 - 生产环境安全加固
management:
  endpoints:
    web:
      exposure:
        include: health,info
  endpoint:
    health:
      show-details: always           # 允许查看详细健康信息
      probes:
        enabled: true                # 启用K8s存活探针支持
      livenessstate:
        enabled: true
      readinessstate:
        enabled: true

# ============================================================
# Common Configuration (Applied to All Environments)
# ============================================================

spring:
  # Jackson JSON 配置
  jackson:
    time-zone: GMT+8
    date-format: yyyy-MM-dd HH:mm:ss
    serialization:
      write-dates-as-timestamps: false
    default-property-inclusion: non_null

  # JPA 公共配置
  jpa:
    open-in-view: false
    properties:
      hibernate:
        jdbc:
          batch_size: 20
          time_zone: Asia/Shanghai
        order_inserts: true
        order_updates: true

  # Flyway 数据库迁移配置
  flyway:
    # 启用Flyway
    enabled: true
    # 迁移脚本位置
    locations: classpath:db/migration
    # 数据库编码
    encoding: UTF-8
    # 迁移时是否校验
    validate-on-migrate: true
    # 基准版本（用于已有数据库的迁移）
    baseline-on-migrate: true
    baseline-version: 0
    # 是否允许无序的迁移脚本
    out-of-order: false
    # 迁移脚本表名
    table: flyway_schema_history

  # 文件上传配置
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 20MB
      enabled: true

# 服务器公共配置
server:
  tomcat:
    uri-encoding: UTF-8
    threads:
      max: 200
      min-spare: 10
  servlet:
    encoding:
      charset: UTF-8
      enabled: true
      force: true

# Actuator 健康检查和监控配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator

  # Prometheus端点配置
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
    prometheus:
      enabled: true

  # 指标配置
  metrics:
    export:
      prometheus:
        enabled: true
        step: 30s
    tags:
      application: ${spring.application.name:HIS}
      environment: ${spring.profiles.active:default}

    # 启用JVM指标
    enable:
      jvm: true
      process: true
      system: true

    # 分布统计配置
    distribution:
      percentiles-histogram:
        sequence.generation.duration: true
        charge.creation.duration: true
        charge.payment.duration: true
      percentiles:
        sequence.generation.duration: 0.5,0.95,0.99
        charge.creation.duration: 0.5,0.95,0.99
        charge.payment.duration: 0.5,0.95,0.99
      slo:
        sequence.generation.duration: 10ms,50ms,100ms
        charge.creation.duration: 100ms,500ms,1000ms

# JWT 配置
jwt:
  # JWT 密钥（生产环境应使用更复杂的密钥，建议通过环境变量配置）
  secret: HIS_SYSTEM_JWT_SECRET_KEY_2025_VERY_LONG_SECRET_KEY_FOR_SECURITY_MUST_BE_AT_LEAST_256_BITS
  # Token 有效期：24小时（单位：毫秒）
  expiration: 86400000

# Springdoc OpenAPI 配置
springdoc:
  api-docs:
    enabled: true
    path: /v3/api-docs
  swagger-ui:
    enabled: true
    path: /swagger-ui.html
    # 设置操作排序
    operations-sorter: alpha
    tags-sorter: alpha
    # 设置默认模型展开深度
    default-models-expand-depth: 1
    default-model-expand-depth: 1
    # 显示请求持续时间
    display-request-duration: true
    # 尝试一下功能
    try-it-out-enabled: true
  # 禁用 actuator 文档
  show-actuator: false

# Knife4j 增强配置
knife4j:
  enable: true
  setting:
    language: zh_cn
    swagger-model-name: 实体类
    # 启用调试功能
    enable-debug: true
    # 启用请求参数缓存
    enable-request-cache: true
    # 启用动态参数
    enable-dynamic-parameter: true
    # 启用版本管理
    enable-version: true
    # 启用搜索功能
    enable-search: true
    # 启用Host配置
    enable-host: false
    # 启用请求重载
    enable-reload-cache-parameter: true
  # 生产环境配置
  production: false
  # 基础认证配置（生产环境建议启用）
  basic:
    enable: false
    username: admin
    password: admin123

# ============================================================
# 监控配置
# ============================================================
monitoring:
  alert:
    # 邮件告警配置
    email:
      # 是否启用邮件告警（生产环境建议启用）
      enabled: false
      # 告警接收邮箱（多个邮箱用逗号分隔）
      to: admin@example.com,ops@example.com
    # 错误告警阈值配置
    error:
      # 每达到多少个错误触发一次告警（默认：100）
      threshold: 100

# ============================================================
# 审计日志配置
# ============================================================
audit:
  log:
    # 审计日志保留期限（单位：天）
    # 默认180天（6个月），满足HIPAA和等保三级基本要求
    # 如需长期保留（如6年），请调整此值并配合定期归档
    retention:
      days: 180
